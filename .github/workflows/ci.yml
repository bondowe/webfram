name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.22', '1.23', '1.24', '1.25']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Set up Go ${{ matrix.go-version }}
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}
        cache: true

    - name: Download dependencies
      run: |
        go mod download
        go mod verify

    - name: Run tests with coverage
      run: |
        go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
        go test -v -race -coverprofile=coverage-openapi.out -covermode=atomic ./openapi/...

    - name: Merge coverage reports
      run: |
        echo "mode: atomic" > coverage-merged.out
        tail -q -n +2 coverage.out coverage-openapi.out >> coverage-merged.out

    - name: Generate coverage report
      run: |
        go tool cover -func=coverage-merged.out -o=coverage.txt
        echo "## Test Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat coverage.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        
        # Calculate total coverage
        COVERAGE=$(go tool cover -func=coverage-merged.out | grep total | awk '{print $3}')
        echo "**Total Coverage: $COVERAGE**" >> $GITHUB_STEP_SUMMARY

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage-merged.out
        flags: unittests
        name: codecov-umbrella-${{ matrix.go-version }}
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Check coverage threshold
      run: |
        COVERAGE=$(go tool cover -func=coverage-merged.out | grep total | awk '{print $3}' | sed 's/%//')
        THRESHOLD=70.0
        echo "Current coverage: $COVERAGE%"
        echo "Required threshold: $THRESHOLD%"
        
        if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
          echo "::error::Coverage $COVERAGE% is below threshold $THRESHOLD%"
          exit 1
        fi

    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v4
      if: matrix.go-version == '1.25'
      with:
        name: coverage-reports
        path: |
          coverage-merged.out
          coverage.txt
        retention-days: 30

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        go-version: ['1.22', '1.23', '1.24', '1.25']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go ${{ matrix.go-version }}
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}
        cache: true

    - name: Build
      run: |
        go build -v ./...
        go build -v ./openapi/...

    - name: Build example
      run: |
        cd cmd/webfram-i18n
        go build -v -o webfram-i18n .

  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
        cache: true

    - name: Run golangci-lint
      uses: golangci/golangci-lint-action@v4
      with:
        version: latest
        args: --timeout=5m

  create-issue-on-failure:
    name: Create Issue on Failure
    runs-on: ubuntu-latest
    needs: [test, build, lint]
    if: failure() && (github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create Issue
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const workflowRunUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          
          // Check if an issue already exists for this workflow failure
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'ci-failure',
            per_page: 100
          });
          
          const existingIssue = issues.data.find(issue => 
            issue.title.includes(`CI Failure on ${context.ref.replace('refs/heads/', '')}`)
          );
          
          const issueBody = `## CI Workflow Failed
          
          **Branch:** ${context.ref.replace('refs/heads/', '')}
          **Commit:** ${context.sha.substring(0, 7)}
          **Triggered by:** ${context.actor}
          **Workflow Run:** [View Details](${workflowRunUrl})
          
          ### Commit Message
          \`\`\`
          ${{ github.event.head_commit.message }}
          \`\`\`
          
          ### Failed Jobs
          One or more jobs in the CI workflow have failed. Please review the workflow run details above.
          
          ### Action Items
          - [ ] Review the failed job logs
          - [ ] Fix the underlying issue
          - [ ] Re-run the workflow or push a fix
          
          ---
          *This issue was automatically created by GitHub Actions.*
          `;
          
          if (existingIssue) {
            // Add a comment to the existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `### New Failure Detected\n\n${issueBody}`
            });
            
            console.log(`Added comment to existing issue #${existingIssue.number}`);
          } else {
            // Create a new issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CI Failure on ${context.ref.replace('refs/heads/', '')} - ${context.sha.substring(0, 7)}`,
              body: issueBody,
              labels: ['ci-failure', 'bug', 'automated']
            });
            
            console.log(`Created new issue #${issue.data.number}`);
          }
